<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.voika.auth.dao.approval.MApprovalDao">

    <!-- 数据字典 -->
    <select id="dir" resultType="com.voika.myundefined.dao.approval.po.ApprovalPO">
        select * from tb_approval
        where 1=1
        <if test="deleted != null">
            and deleted = #{deleted}
        </if>
        <if test="bizId != null">
            and biz_id = #{bizId}
        </if>
        <if test="relationKey != null">
            and relation_key = #{relationKey}
        </if>
        <if test="approvalType != null">
            and approval_type = #{approvalType}
        </if>
        <if test="approvalStatus != null">
            and approval_status = #{approvalStatus}
        </if>
        <if test="approvalInfo != null">
            and approval_info like concat('%',#{approvalInfo},'%')
        </if>
    </select>

    <!-- 分页查询 -->
    <select id="searchPage" parameterType="com.voika.myundefined.infrastructure.entity.dto.approval.ApprovalSearchPageDTO"
            resultType="com.voika.myundefined.dao.approval.po.ApprovalPO">
        select *
        from tb_approval
        where deleted = 0
        <if test="approvalType != null">
            and approval_type = #{approvalType}
        </if>
        <if test="approvalStatus != null">
            and approval_status = #{approvalStatus}
        </if>
        <if test="approvalInfo != null">
            and approval_info like concat('%',#{approvalInfo},'%')
        </if>
        order by create_time desc
    </select>

    <!-- 通用插入 -->
    <insert id="insert" parameterType="com.voika.myundefined.dao.approval.po.ApprovalPO">
        insert into tb_approval(
        biz_id
        <if test="relationKey != null">
            ,relation_key
        </if>
        <if test="approvalType != null">
            ,approval_type
        </if>
        <if test="approvalStatus != null">
            ,approval_status
        </if>
        <if test="approvalInfo != null">
            ,approval_info
        </if>
        <if test="extension != null">
            ,extension
        </if>
        <if test="deleted != null">
            ,deleted
        </if>
        <if test="createTime != null">
            ,create_time
        </if>
        <if test="modifyTime != null">
            ,modify_time
        </if>
        <if test="creatorId != null">
            ,creator_id
        </if>
        <if test="creatorName != null">
            ,creator_name
        </if>
        <if test="operatorId != null">
            ,operator_id
        </if>
        <if test="operatorName != null">
            ,operator_name
        </if>
        <if test="version != null">
            ,version
        </if>
        ) values (
        #{bizId}
        <if test="relationKey != null">
            ,#{relationKey}
        </if>
        <if test="approvalType != null">
            ,#{approvalType}
        </if>
        <if test="approvalStatus != null">
            ,#{approvalStatus}
        </if>
        <if test="approvalInfo != null">
            ,#{approvalInfo}
        </if>
        <if test="extension != null">
            ,#{extension}
        </if>
        <if test="deleted != null">
            ,#{deleted}
        </if>
        <if test="createTime != null">
            ,#{createTime}
        </if>
        <if test="modifyTime != null">
            ,#{modifyTime}
        </if>
        <if test="creatorId != null">
            ,#{creatorId}
        </if>
        <if test="creatorName != null">
            ,#{creatorName}
        </if>
        <if test="operatorId != null">
            ,#{operatorId}
        </if>
        <if test="operatorName != null">
            ,#{operatorName}
        </if>
        <if test="version != null">
            ,#{version}
        </if>
        )
    </insert>

    <!-- 根据bizId更新不为null -->
    <update id="updateByBizId">
        update tb_approval set modify_time = now()
        <if test="relationKey != null">
            ,relation_key = #{relationKey}
        </if>
        <if test="approvalType != null">
            ,approval_type = #{approvalType}
        </if>
        <if test="approvalStatus != null">
            ,approval_status = #{approvalStatus}
        </if>
        <if test="approvalInfo != null">
            ,approval_info = #{approvalInfo}
        </if>
        <if test="extension != null">
            ,extension = #{extension}
        </if>
        <if test="deleted != null">
            ,deleted = #{deleted}
        </if>
        <if test="createTime != null">
            ,create_time = #{createTime}
        </if>
        <if test="modifyTime != null">
            ,modify_time = #{modifyTime}
        </if>
        <if test="creatorId != null">
            ,creator_id = #{creatorId}
        </if>
        <if test="creatorName != null">
            ,creator_name = #{creatorName}
        </if>
        <if test="operatorId != null">
            ,operator_id = #{operatorId}
        </if>
        <if test="operatorName != null">
            ,operator_name = #{operatorName}
        </if>
        <if test="version != null">
            ,version = #{version}
        </if>
        where deleted = 0 and biz_id=#{bizId}
    </update>

    <!-- 删除审批记录 -->
    <delete id="delete">
        update tb_approval
        set deleted = 1
        where
        <choose>
            <when test="type == 1">
                biz_id = #{bizId}
            </when>
            <otherwise>
                <choose>
                    <when test="type == 3">
                        1=1
                    </when>
                    <otherwise>
                        <choose>
                            <when test="type == 2">
                                biz_id in
                                <foreach collection="bizIds" item="x" open="(" separator="," close=")" index="index">
                                    #{x}
                                </foreach>
                            </when>
                            <otherwise></otherwise>
                        </choose>
                    </otherwise>
                </choose>
            </otherwise>
        </choose>

    </delete>

</mapper>